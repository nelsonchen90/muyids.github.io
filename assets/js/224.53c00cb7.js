(window.webpackJsonp=window.webpackJsonp||[]).push([[224],{382:function(e,v,_){"use strict";_.r(v);var s=_(42),a=Object(s.a)({},(function(){var e=this,v=e.$createElement,_=e._self._c||v;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h1",{attrs:{id:"设计一个聊天系统"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#设计一个聊天系统"}},[e._v("#")]),e._v(" 设计一个聊天系统")]),e._v(" "),_("h2",{attrs:{id:"场景scenario"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#场景scenario"}},[e._v("#")]),e._v(" 场景Scenario")]),e._v(" "),_("p",[e._v("基本功能：")]),e._v(" "),_("ol",[_("li",[e._v("两个用户点对点聊天")]),e._v(" "),_("li",[e._v("群聊")]),e._v(" "),_("li",[e._v("用户在线状态")]),e._v(" "),_("li",[e._v("用户系统：用户登录注册，用户的通讯录（好友信息，群组）")])]),e._v(" "),_("p",[e._v("其他功能：")]),e._v(" "),_("ol",[_("li",[e._v("历史消息")]),e._v(" "),_("li",[e._v("多机登录")])]),e._v(" "),_("p",[e._v("以微信为例，估计QPS，存储")]),e._v(" "),_("p",[e._v("日活用户估计")]),e._v(" "),_("p",[e._v("1B月活，75%日活，约750M日活，假设我们要设计一个100M日活的聊天系统")]),e._v(" "),_("p",[e._v("QPS: 假设平均一个用户一天发送20条信息，Average QPS = 20 * 100 M / 100 K seconds = 20K")]),e._v(" "),_("p",[e._v("Peek QPS : 20K * 5 = 100K")]),e._v(" "),_("p",[e._v("存储：")]),e._v(" "),_("p",[e._v("每个用户发送 20条消息，1B日活用户，30bytes一条消息，20 * 1B * 30bytes = 60G")]),e._v(" "),_("h2",{attrs:{id:"服务service"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#服务service"}},[e._v("#")]),e._v(" 服务Service")]),e._v(" "),_("p",[e._v("Message Service: 负责消息管理")]),e._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",[_("code",[e._v("- saveMsg\n- getMsgList\n")])])]),_("p",[e._v("Real-time Service（Broker）: 实时消息推送")]),e._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",[_("code",[e._v("Broker {Publisher, Subscriber}\n")])])]),_("p",[e._v("User Service 用户服务")]),e._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",[_("code",[e._v("登录，注册，通讯录等\n")])])]),_("h2",{attrs:{id:"storage存储"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#storage存储"}},[e._v("#")]),e._v(" Storage存储")]),e._v(" "),_("p",[e._v("Message {\nid， from, to, content, created_at\n}")]),e._v(" "),_("p",[e._v("如果这样设计，查询A和B的聊天消息，需要")]),e._v(" "),_("p",[e._v("select * from msgtable where from=A and to=B or from=B and to=A order by created_at desc;")]),e._v(" "),_("p",[e._v("问题：")]),e._v(" "),_("ol",[_("li",[e._v("SQL复杂，效率低下")]),e._v(" "),_("li",[e._v("多人聊天，无法扩展")])]),e._v(" "),_("p",[e._v("需要添加一个会话ID（sessionId）")]),e._v(" "),_("p",[e._v("两个人聊天，可以按 A和B的用户id 升序排列，中间分隔符隔开")]),e._v(" "),_("p",[e._v("另外，会话列表怎么实现？")]),e._v(" "),_("p",[e._v("增加session表")]),e._v(" "),_("p",[e._v("Session {\nownerId, sessionId, participant_ids, is_muted, nickname, created_at, updated_at\n}")]),e._v(" "),_("p",[e._v("优化消息表")]),e._v(" "),_("p",[e._v("Message {\nid，sessionId, from, content, created_at\n}")]),e._v(" "),_("p",[e._v("选择存储类型SQL or NOSQL?")]),e._v(" "),_("p",[e._v("Message Table -> NoSQL : 数据量很大，不需要修改，一条聊天信息就像一条log一样")]),e._v(" "),_("p",[e._v("Session Table -- 对话表（SQL)")]),e._v(" "),_("p",[e._v("对话表需要的索引")]),e._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",[_("code",[e._v("查询单个会话信息 ownerId + sessionId (primary key)\n\n查询会话列表 ownerId + updated_at\nselect * from Session where ownerId=X order by updated_at desc\n")])])]),_("p",[e._v("NoSQL对二级索引的支持并不友好，所以考虑SQL")]),e._v(" "),_("p",[e._v("100 个 会话消息, 10B用户， 1000 B 条消息，水平拆分 ， 用户id mod 10000 分为1万张表保存 会话表")]),e._v(" "),_("hr"),e._v(" "),_("p",[e._v("群聊的消息如何推送？")]),e._v(" "),_("p",[e._v("以500人的群聊为例，实际上很少一部分人实时在线")]),e._v(" "),_("p",[e._v("我们需要知道谁是在线的")]),e._v(" "),_("p",[e._v("增加Channel Service（Topic Service）, 为每个会话增加一个Channel信息")]),e._v(" "),_("p",[e._v("用户登录时，需要先订阅对应的Channel；用户断线了，broker通知Channel移除掉")]),e._v(" "),_("p",[e._v("这样Channel就知道频道里哪些用户还活着")]),e._v(" "),_("p",[e._v("群发消息时，push给channel service, channel service查到在线用户，发给Push Service(Broker), 给在线用户推消息")]),e._v(" "),_("hr"),e._v(" "),_("p",[e._v("在线离线状态更新")]),e._v(" "),_("p",[e._v("上线，主动下线 都向服务器上报状态\n被动下线（网络断开等），使用心跳机制，每隔10秒上报自己的最后在线时间")]),e._v(" "),_("p",[e._v("请求用户在线状态时，使用拉的方式，判断最后在线时间是否在10秒内，如果不在，就是离线")]),e._v(" "),_("p",[e._v("facebook大概3-5秒pull一次服务器")]),e._v(" "),_("hr"),e._v(" "),_("p",[e._v("Broker 机器数量：100 M 用户同时在线；单台机器 支持的 socket连接数可以达到65535")]),e._v(" "),_("hr"),e._v(" "),_("p",[e._v("小知识")]),e._v(" "),_("p",[e._v("RateLimiter访问限制器")]),e._v(" "),_("p",[e._v("如何限制访问次数？")]),e._v(" "),_("p",[e._v("滑动窗口 -- 这其实是一道算法题")]),e._v(" "),_("h2",{attrs:{id:"扩展学习"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#扩展学习"}},[e._v("#")]),e._v(" 扩展学习")]),e._v(" "),_("p",[e._v("https://time.geekbang.org/column/article/137453")])])}),[],!1,null,null,null);v.default=a.exports}}]);