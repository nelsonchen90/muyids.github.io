(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{516:function(s,a,t){"use strict";t.r(a);var n=t(42),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"使用lua脚本的好处"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用lua脚本的好处"}},[s._v("#")]),s._v(" 使用lua脚本的好处")]),s._v(" "),t("ol",[t("li",[s._v("减少网络开销：本来5次网络请求的操作，可以用一个请求完成")]),s._v(" "),t("li",[s._v("原子操作：Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入")]),s._v(" "),t("li",[s._v("复用：客户端发送的脚本会永久存储在Redis中，意味着其他客户端可以复用这一脚本而不需要使用代码完成同样的逻辑。")])]),s._v(" "),t("h1",{attrs:{id:"准备条件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备条件"}},[s._v("#")]),s._v(" 准备条件")]),s._v(" "),t("ul",[t("li",[s._v("redis在服务器端内置lua解释器（版本2.6以上）")]),s._v(" "),t("li",[s._v("redis-cli提供了"),t("code",[s._v("EVAL")]),s._v("与"),t("code",[s._v("EVALSHA")]),s._v("命令执行Lua脚本")])]),s._v(" "),t("h1",{attrs:{id:"redis内置lua执行命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis内置lua执行命令"}},[s._v("#")]),s._v(" redis内置lua执行命令")]),s._v(" "),t("h2",{attrs:{id:"eval命令语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eval命令语法"}},[s._v("#")]),s._v(" EVAL命令语法")]),s._v(" "),t("blockquote",[t("p",[s._v("EVAL script numkeys key [key …] arg [arg …]")])]),s._v(" "),t("ul",[t("li",[s._v("EVAL —- lua程序的运行环境上下文")]),s._v(" "),t("li",[s._v("script —- lua脚本")]),s._v(" "),t("li",[s._v("numkeys —- 参数的个数(key的个数)")]),s._v(" "),t("li",[s._v("key —- redis键,访问下标从1开始,例如:KEYS[1]")]),s._v(" "),t("li",[s._v("arg —- redis键的附加参数")])]),s._v(" "),t("h2",{attrs:{id:"evalsha-命令语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#evalsha-命令语法"}},[s._v("#")]),s._v(" EVALSHA 命令语法")]),s._v(" "),t("blockquote",[t("p",[s._v("EVALSHA SHA1 numkeys key [key …] arg [arg …]")])]),s._v(" "),t("p",[s._v("EVALSHA命令允许通过脚本的SHA1来执行(节省带宽)")]),s._v(" "),t("p",[s._v("Redis在执行EVAL/SCRIPT LOAD后会计算脚本SHA1缓存, EVALSHA根据SHA1取出缓存脚本执行")]),s._v(" "),t("h2",{attrs:{id:"redis中管理lua脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis中管理lua脚本"}},[s._v("#")]),s._v(" Redis中管理Lua脚本")]),s._v(" "),t("ul",[t("li",[s._v("script load script 将Lua脚本加载到Redis内存中(如果redis重启则会丢失)")]),s._v(" "),t("li",[s._v("script exists sh1 [sha1 …] 判断sha1脚本是否在内存中")]),s._v(" "),t("li",[s._v("script flush 清空Redis内存中所有的Lua脚本")]),s._v(" "),t("li",[s._v("script kill 杀死正在执行的Lua脚本。（如果此时Lua脚本正在执行写操作，那么script kill将不会生效）")])]),s._v(" "),t("p",[s._v("Redis提供了一个lua-time-limit参数，默认5秒，它是Lua脚本的超时时间,如果Lua脚本超时，其他执行正常命令的客户端会收到“Busy Redis is busy running a script”错误，但是不会停止脚本运行，此时可以使用script kill 杀死正在执行的Lua脚本。")]),s._v(" "),t("h2",{attrs:{id:"lua函数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lua函数"}},[s._v("#")]),s._v(" lua函数")]),s._v(" "),t("p",[s._v("主要有两个函数来执行redis命令")]),s._v(" "),t("ul",[t("li",[s._v("redis.call() –- 出错时返回具体错误信息,并且终止脚本执行")]),s._v(" "),t("li",[s._v("redis.pcall() –- 出错时返回lua table的包装错误,但不引发错误")])]),s._v(" "),t("p",[s._v("使用流程如下：")]),s._v(" "),t("ol",[t("li",[s._v("编写脚本")]),s._v(" "),t("li",[s._v("脚本提交到REDIS并获取SHA")]),s._v(" "),t("li",[s._v("使用SHA调用redis脚本")])]),s._v(" "),t("h1",{attrs:{id:"redis运行lua脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis运行lua脚本"}},[s._v("#")]),s._v(" redis运行lua脚本")]),s._v(" "),t("h2",{attrs:{id:"eval-直接运行脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eval-直接运行脚本"}},[s._v("#")]),s._v(" EVAL 直接运行脚本")]),s._v(" "),t("blockquote",[t("p",[s._v('EVAL "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}" 2 key1 key2 first second')])]),s._v(" "),t("h2",{attrs:{id:"evalsha使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#evalsha使用"}},[s._v("#")]),s._v(" EVALSHA使用")]),s._v(" "),t("p",[s._v("需要"),t("code",[s._v("SCRIPT LOAD")]),s._v("和"),t("code",[s._v("EVALSHA")]),s._v("配合使用")]),s._v(" "),t("ol",[t("li",[s._v("SCRIPT LOAD加载到内存，返回SHA签名")]),s._v(" "),t("li",[s._v("EVALSHA使用已经存在的签名")])]),s._v(" "),t("p",[s._v("这样只用加载一次，便可重复使用已经加载的签名脚本，可以多次使用，避免长脚本输入")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('> SCRIPT LOAD "return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}"\n"a42059b356c875f0717db19a51f6aaca9ae659ea"\nEVALSHA "a42059b356c875f0717db19a51f6aaca9ae659ea" 2 key1 key2 first second\n1) "key1"\n2) "key2"\n3) "first"\n4) "second"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"在redis下使用脚本文件执行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#在redis下使用脚本文件执行"}},[s._v("#")]),s._v(" 在redis下使用脚本文件执行")]),s._v(" "),t("p",[s._v("在路径下创建脚本文件，这里直接在"),t("code",[s._v("redis/bin")]),s._v("下创建，方便使用，其他目录可以使用全路径")]),s._v(" "),t("p",[t("code",[s._v("set.lua")])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--[[ set.lua, redis的set命令使用 \nredis: set key val\n--]]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" val "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'set'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" val"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("设置k-v值，运行命令")]),s._v(" "),t("blockquote",[t("p",[s._v("redis-cli --eval ./set.lua foo , bar")])]),s._v(" "),t("p",[t("strong",[s._v("注意")]),s._v("："),t("code",[s._v("redis-cli --eval set.lua foo , bar")]),s._v("，foo和bar之间的逗号左右都有空格分隔,否则会当做一个字符串")]),s._v(" "),t("p",[s._v("通过redis-cli查看值")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('127.0.0.1:6379> get foo\n"bar"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("code",[s._v("get.lua")])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--[[ get.lua, redis的get命令使用 \nredis: get key\n--]]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" val "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"GET"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" val"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("获取k值，运行命令")]),s._v(" "),t("blockquote",[t("p",[s._v("redis-cli --eval ./get.lua foo")])]),s._v(" "),t("p",[s._v("通常做法是")]),s._v(" "),t("ol",[t("li",[s._v("脚本文件保存到一个路径下或者数据库中，比如："),t("code",[s._v("/mnt/redis/lua/set.lua")])]),s._v(" "),t("li",[t("code",[s._v("SCRIPT LOAD")]),s._v(" 加载脚本文件内容，返回SHA签名保存到应对的值K-V值，(set,SHA)")]),s._v(" "),t("li",[s._v("获取对应脚本名称的SHA签名，如果存在则执行，否则进行第二步操作")])]),s._v(" "),t("h1",{attrs:{id:"实际开发应用实战"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实际开发应用实战"}},[s._v("#")]),s._v(" 实际开发应用实战")]),s._v(" "),t("h2",{attrs:{id:"访问次数限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问次数限制"}},[s._v("#")]),s._v(" 访问次数限制")]),s._v(" "),t("p",[s._v("需求场景：限制用户在一段时间内只能访问某一资源限定次数")]),s._v(" "),t("p",[s._v("ratelimiting.lua")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" times "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incr'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" times "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'expire'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" times "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("运行脚本（限定10秒内最多访问3次）：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("redis-cli --eval ratelimiting.lua rate.limitingl:127.0.0.1 , 10 3\n(integer) 1\nredis-cli --eval ratelimiting.lua rate.limitingl:127.0.0.1 , 10 3\n(integer) 1\nredis-cli --eval ratelimiting.lua rate.limitingl:127.0.0.1 , 10 3\n(integer) 1\nredis-cli --eval ratelimiting.lua rate.limitingl:127.0.0.1 , 10 3\n(integer) 0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("rate.limitingl:127.0.0.1是前缀+ip组成的KEY，用KEYS[1]获取，")]),s._v(" "),t("li",[s._v('","后面的10和3是参数，在脚本中能够使用ARGV[1]和ARGV[2]获得')])]),s._v(" "),t("p",[s._v("命令的作用是将访问频率限制为每10秒最多3次，所以在终端中不断的运行此命令会发现当访问频率在10秒内小于或等于3次时返回1，否则返回0。")]),s._v(" "),t("h2",{attrs:{id:"lua实现redis分布式锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lua实现redis分布式锁"}},[s._v("#")]),s._v(" lua实现redis分布式锁")]),s._v(" "),t("p",[s._v("分布式锁需要考虑的问题")]),s._v(" "),t("ol",[t("li",[s._v("失效时间；如果没有失效时间，当解锁失败时，就会导致锁记录一直在tair中，其他线程无法再获得到锁。")]),s._v(" "),t("li",[s._v("非阻塞：分布式锁应该是非阻塞的，无论成功还是失败都直接返回")]),s._v(" "),t("li",[s._v("非重入：一个线程获得锁之后，在释放锁之前，无法再次获得该锁")])]),s._v(" "),t("h3",{attrs:{id:"实现思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现思路"}},[s._v("#")]),s._v(" 实现思路")]),s._v(" "),t("p",[t("strong",[s._v("setnx")]),s._v("：如果key不存在则添加值并返回1，如果已经存在key则返回0")]),s._v(" "),t("p",[t("strong",[s._v("加锁")])]),s._v(" "),t("p",[s._v("使用业务setnx(key,业务流水号)当加锁成功返回1时设置过期时间，避免业务异常没有解锁时防止死锁")]),s._v(" "),t("p",[t("strong",[s._v("重入锁")])]),s._v(" "),t("p",[s._v("当同一业务再次申请锁时，如果随机值相同 则认为是重试,则直接设置过期时长；如果随机值不同则直接返回0，获取锁失败")]),s._v(" "),t("p",[t("strong",[s._v("解锁")])]),s._v(" "),t("p",[s._v("业务完成直接del(key)完成")]),s._v(" "),t("p",[s._v("以上方案是很多客户端实现的方式，建立和释放锁，并保证绝对的安全，是这个锁的设计比较棘手的地方。有两个潜在的陷阱：")]),s._v(" "),t("ol",[t("li",[s._v("应用程序通过网络和redis交互，这意味着从应用程序发出命令到redis结果返回之间会有延迟。这段时间内，redis可能正在运行其他的命令，而redis内数据的状态可能不是你的程序所期待的。如果保证程序中获取锁的线程和其他线程不发生冲突？")]),s._v(" "),t("li",[s._v("如果程序在获取锁后突然crash，而无法释放它？这个锁会一直存在而导致程序进入“死锁”")])]),s._v(" "),t("p",[s._v("对于第一个问题，除了pile批量一次执行，目前只有lua脚本是在同一个线程中一次执行完的。\n第二个问题，如果在获取锁之后，设置expire之前发生了异常，那么这个key-v永远都不会过期，即便是lua脚本也是一样会发生这样的情况（通常是设置过期时间这个参数设置的不是数字类型，虽然这种情况不太可能发生），但仍然比客户端多条命令执行来的更加简短")]),s._v(" "),t("p",[s._v("lock.lua")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- Set a lock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--  如果获取锁成功，则返回 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" key     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" content "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ttl     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" lockSet "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setnx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" content"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" lockSet "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PEXPIRE'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ttl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 如果value相同，则认为是同一个线程的请求，则认为重入锁")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'get'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" content"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    lockSet "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PEXPIRE'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ttl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" lockSet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("unlock.lua")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- unlock key")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" key     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" KEYS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" content "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ARGV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'get'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" content "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'del'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("测试加锁和解锁")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("redis-cli  --eval lock.lua lo3 , 2 60000\nredis-cli  --eval unlock.lua lo3 , 2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h1",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ul",[t("li",[s._v("https://github.com/mike-marcacci/node-redlock")])])])}),[],!1,null,null,null);a.default=e.exports}}]);